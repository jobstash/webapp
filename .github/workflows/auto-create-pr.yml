name: Auto-create PR

on:
  push:
    branches-ignore:
      - main
      - dev

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Pull Request
        run: |
          # Validate branch name and generate commitlint-compatible title
          TITLE=$(node scripts/validate-branch-and-generate-title.js "${{ github.ref_name }}")

          # Extract scope (before slash) for PR label
          SCOPE=$(echo "${{ github.ref_name }}" | cut -d'/' -f1)

          # Create PR from current branch to dev, or skip if already exists
          PR_URL=$(gh pr create \
            --base dev \
            --head ${{ github.ref_name }} \
            --title "$TITLE" \
            --body "Auto-generated PR from branch \`${{ github.ref_name }}\`" \
            || gh pr view ${{ github.ref_name }} --json url --jq '.url')

          echo "PR URL: $PR_URL"

          # Apply label if it matches commitlint scope
          if [[ "$SCOPE" =~ ^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)$ ]]; then
            echo "Adding label '$SCOPE' to PR"
            gh pr edit "$PR_URL" --add-label "$SCOPE"
          else
            echo "No matching scope label to add"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
